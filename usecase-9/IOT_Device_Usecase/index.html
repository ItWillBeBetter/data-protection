<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="aws-security-workshops@amazon.com">
        <link rel="canonical" href="https://data-protection.awssecworkshops.com/usecase-9/IOT_Device_Usecase/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>IOT Device Usecase - Data Protection on AWS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../stylesheets/custom.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Data Protection on AWS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Overview</a>
                            </li>
                            <li class="navitem">
                                <a href="../../contribute/" class="nav-link">Contributing</a>
                            </li>
                            <li class="navitem">
                                <a href="../../license/" class="nav-link">License</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/aws-samples/data-protection/edit/master/docs/usecase-9/IOT_Device_Usecase.md" class="nav-link">Edit on aws-samples/data-protection</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#iot-device-certificates" class="nav-link">IOT device certificates :</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="iot-device-certificates">IOT device certificates :</h2>
<p>If you are building IOT applications where client devices need to validate their identity to central control servers, you could use AWS IOT core or your own control server that your organization has built. In this section of the workshop, we will go through a hands on exercise showing you how you get client device certificates and deploy them to an IOT device simulator and also how the AWS IOT core validates these device certificates.</p>
<h3 id="0-create-the-base-template">0. Create the base template</h3>
<p>Run the CF template stack template-security-admin.yaml in your isengard account.</p>
<p>Also remember that please don't create CRL's when you created CA's as CRL's required public S3 buckets and I would think that your isengard account is probably having the setting of blocking public S3 buckets.</p>
<h3 id="1-an-iam-role-called-iotdevrole-is-the-role-that-an-iot-developer-would-assume">1. An IAM Role called <strong>IOTDevRole</strong> is the role that an IOT developer would assume.</h3>
<ul>
<li>
<p>Assume the role named <strong>IOTDevRole</strong> by using switch role on the AWS console in the AWS account that you are currently logged into</p>
</li>
<li>
<p>This role has permissions that an IOT developer will need for building the necessary resources for IOT device certificate authentication use case.</p>
</li>
<li>
<p>If you are not familiar with switching roles, follow this tutorial if needed: Right click on <a href="https://view.highspot.com/viewer/5f184e81628ba22ac32681e1">Assume Role in Console</a></p>
</li>
</ul>
<h4 id="2-build-the-infrastructure-needed-for-the-iot-usecase-by-deploying-the-cloudformation-template-below">2. Build the infrastructure needed for the IOT usecase by deploying the cloudformation template below</h4>
<p>Please download the CF template by right clicking and save link as the filename <em>template-iot-dev.yaml</em> <a href="https://code.amazon.com/packages/AWS-Certificate-Manager-Workshop/blobs/mainline/--/cf-templates/template-iot-dev.yaml">IOT Developer Cloudformation Stack</a> by right clicking and saving the yaml file on your laptop. </p>
<p>Upload and launch the cloudformation stack in your AWS account. If you are not familiar with this, follow instructions here by right clicking and opening link in a new browser tab <a href="https://view.highspot.com/viewer/5dd6cd3c6a3b1102db4ac3ca">Deploy IOT Developer Cloudformation Stack Instructions</a>
This cloudformation deployment takes about 2 minutes to complete.</p>
<h4 id="3-for-the-next-section-you-need-a-cloud9-ide-environment-setup-for-executing-code-please-follow-the-instructions-below">3. For the next section, you need a Cloud9 IDE environment setup for executing code. PLease follow the instructions below :</h4>
<ul>
<li>Navigate to the Cloud9 service within your AWS console</li>
<li>Open the Cloud9 IDE environment called <strong>IOT usecase environment</strong>. It takes about 30 seconds for the environment to start up.</li>
<li>In the Cloud9 IDE environment you will find a folder called <strong>AWS-Certificate-Manager-Workshop</strong> in the folder pane on the left side of the screen</li>
<li>
<p>Delete that folder</p>
</li>
<li>
<p>WE need to do this until we get a public github repo. Working on this right now. In the interim do this</p>
</li>
</ul>
<p>In your mac terminal do the below :</p>
<p>git clone ssh://git.amazon.com/pkg/AWS-Certificate-Manager-Workshop</p>
<p>From your laptop Copy the AWS-Certificate-Manager-Workshop directory to S3 in your isengard account.</p>
<p>Within your Cloud9 environment copy the whole <strong>AWS-Certificate-Manager-Workshop</strong> directory into your Cloud9 environment</p>
<ul>
<li>Right-click (on MacOS: control-click) the file named <strong>environment-setup.sh</strong> in the IDE and select Run</li>
<li>This script takes about a minute to complete</li>
<li>The script installs various tools and packages for this section of the workshop, see the comments in the script for more information</li>
<li>The script is finished when you see <strong>environment setup complete</strong>, additional log info can be found in the file <code>setup.log</code></li>
</ul>
<h4 id="4-create-the-verification-certificate-and-get-it-signed-by-the-subordinate-ca">4. Create the verification certificate and get it signed by the Subordinate CA</h4>
<p>The verification certificate is needed because that's the mechanism that the AWS IOT core uses to ascertain that you have access to the  Subordinate CA for signing an end entity certificate. There is also a registration code that's needed in the process and this code is used by the AWS IOT core to ascertain that the principal creating and uploading the verification certificate operation has permissions to access to the IOT Core within the AWS console.</p>
<p>In the Cloud9 environment :</p>
<p>Open a bash terminal. </p>
<p>Change directory to /home/ec2-user/environment by using the following command :</p>
<pre class="codehilite"><code>cd /home/ec2-user/environment/AWS-Certificate-Manager-Workshop
</code></pre>

<p>Generate a RSA 2048 key pair using the command below. A file verification_cert.key will be created.</p>
<pre class="codehilite"><code>openssl genrsa -out verification_cert.key 2048
</code></pre>

<p>Each AWS account has a unique IOT registration code. As part of the verification process, the common name of the CSR(Certificate signing request) must be set to the registration code.</p>
<p>Let's get the registration code from IOT core to put into the Common name for the CSR. Copy the registration code to your clipboard.</p>
<pre class="codehilite"><code>aws iot get-registration-code
</code></pre>

<p>We will now generate the verification certificate signing request(CSR). Fill in values at the prompt and when prompted for <code>Common name</code> enter the registration code(without quotes) as returned by the above command. For other parameters choose anything you like. Don't put anything for the challenge password or optional company name, just press enter and it should be good.</p>
<pre class="codehilite"><code>openssl req -new -key verification_cert.key -out verification_cert.csr
</code></pre>

<p>You should see the file verification_cert.csr generated.</p>
<p>The verification_cert.csr will be now signed by the subordinate CA and the certificate content is put into a .pem file</p>
<p>Run the script <code>verification-cert.sh</code> using the command below :</p>
<pre class="codehilite"><code>bash verification-cert.sh
</code></pre>

<p>This script will issue the validation certificate and also get the subordinate CA certificate and upload it to the S3 bucket named <code>certificate-holder-&lt;your-account-number&gt;</code>. The bucket would be in the region that you are currently operating in.</p>
<p>At this point the AWS IOT core has determined that you have the necessary permissions to sign a device certificate using the subordinate CA in your account.</p>
<h4 id="5-download-the-subordinate-ca-certificate-and-verification-certificate-from-the-s3-bucket-into-your-laptop">5. Download the subordinate CA certificate and verification certificate from the S3 bucket into your laptop</h4>
<p>Follow the instructions here :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/5f184ed28117173ffa84f72b">Download Verification cert and subordinate CA cert</a></p>
<h4 id="6-register-the-ca-by-uploading-subordinate-ca-certificate-and-verification-certificate-to-iot-core-on-the-aws-console">6. Register the CA by uploading Subordinate CA certificate and Verification certificate to IOT core on the AWS console</h4>
<p>Follow the instructions here :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/5f18a1ce66bbaa7e29833e71">Register a CA </a></p>
<p>Now the IOT core is loaded with the subordinate CA certificate. This means that any device certificate that's signed by the Subordinate CA can be trusted and validated by the IOT core.</p>
<h4 id="7-lets-create-a-device-certificate-in-the-cloud9-environment">7. Let's create a device certificate in the Cloud9 environment</h4>
<p>In this step you will create a device certificate that you will then associate with an IOT thing. Within the Cloud9 environment, open a terminal and execute the following commands to create a RSA key pair for the IOT device:</p>
<pre class="codehilite"><code>openssl genrsa -out device_cert.key 2048
</code></pre>

<p>Let's generate the CSR for the IOT device. For the CSR Parameters, you can put "iotdevice1" for Common name but for all other parameters its your choice. Don't set anything for the challenge password and the optional company name. Just press enter for those parameters. Use the following command to generate the CSR(Certificate signing request)</p>
<pre class="codehilite"><code>openssl req -new -key device_cert.key -out device_cert.csr
</code></pre>

<p>Run the script <code>device-cert.sh</code> which will issue the device certificate and get it signed by the subordinate CA that you created earlier and upload it to the S3 bucket named <code>certificate-holder-&lt;your-account-number&gt;</code>. You can use the command below :</p>
<pre class="codehilite"><code>bash device-cert.sh
</code></pre>

<h4 id="8-download-the-device-certificate-from-s3-back-to-the-cloud9-environment">8. Download the device certificate from S3 back to the Cloud9 environment</h4>
<p>Go to the S3 console and follow the instructions below :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/5f18b1f4659e9336da5e727e">Download the device cert from S3</a></p>
<h4 id="9-create-the-iot-policy-that-provides-permissions-for-publishing-and-subscribing-to-a-iot-topic">9. Create the IOT Policy that provides permissions for publishing and subscribing to a IOT topic</h4>
<p>The IOT policy attached to a thing or a device provides permissions to a device or a thing for topics the IOT thing can publish and subscribe to. The policy also provides the ability to add a name to the thing that connects to the IOT core.</p>
<p>Follow the instructions here :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/5f19b8ee659e93182eb6b92a">Create IOT policy</a></p>
<p>You have now created a policy called <code>alexa_temperature_policy</code> . This policy will allow a IOT device to publish to a topic named 'alexa/temperature'. For example think of a IOT device recording temperature and is publishing to this IOT topic called <code>alexa/temperature</code>. You will attach the policy to a IOT thing in later steps.</p>
<h4 id="10-register-the-device-certificate-and-create-a-thing-within-the-iot-core-service">10. Register the device certificate and create a thing within the IOT core service</h4>
<p>Follow the instructions here :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/5f1f277a66bbaa57631f67d3">Create and register a IOT thing</a></p>
<h4 id="11-configuring-the-mqttstandard-for-iot-messaing-client">11. Configuring the MQTT(Standard for IOT Messaing) Client</h4>
<p>We will be using a MQTT client to simulate a IOT device. An MQTT cliens has been pre-installed in your Cloud9 environment. The mqtt client needs to communicate with the IOT core endpoint and the various certificates and keys required for a mutual TLS connection between the mqtt client and the AWS IOT core endpoint have been configured within the config.properties mqq configuration file.</p>
<p>Open the mqtt configuration file from a bash terminal in your Cloud9 environment:</p>
<pre class="codehilite"><code>c9 open /home/ec2-user/.mqtt-cli/config.properties 
</code></pre>

<p>In a bash terminal withiny our Cloud9 environment, use the following cli command in the terminal to get the mqtt endpoint URL or mqtt host</p>
<pre class="codehilite"><code>aws iot describe-endpoint --endpoint-type iot:Data-ATS
</code></pre>

<p>The output will be in this format </p>
<p>{
    "endpointAddress": "b12qfcnz2tnjiu-ats.iot.us-east-1.amazonaws.com"
}</p>
<p>Copy the value of the parameter endpointAddress into the value of mqtt.host in the config.properties file.</p>
<p>Also change the other properties to the values shown below. Don't forget to save the file.</p>
<pre class="codehilite"><code>mqtt.port=8883
mqtt.host= {Value of the endpointAddress produced by the above describe-endpoint CLI Command}
mqtt.version=3
client.id.prefix=mydevice
</code></pre>

<h4 id="12-pub-sub-exercise-where-we-can-see-messages-flowing-between-the-device-simulator-and-the-iot-core-topic-over-a-https-connection">12. Pub sub exercise where we can see messages flowing between the device simulator and the IOT core topic over a HTTPS connection.</h4>
<p>Navigate to the AWS IOT core service in a browser tab and follow the instructions below :</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/603567b6c7143363bf6ee359">Subscribe to a IOT topic</a></p>
<p><strong>Publishing from MQTT Client to IOT core:</strong></p>
<p>Open the mqtt shell by typing the following command :</p>
<pre class="codehilite"><code>mqtt shell
</code></pre>

<p>Publishing from MQTT client to IOT core</p>
<p>Connect to IOT core using the following command and then publish the Hello message using the pub command. Press enter after each command :</p>
<pre class="codehilite"><code>con -i mydevice

pub -t alexa/temperature -m Hello 
</code></pre>

<p>Follow instructions here to see the message sfomr the MQTT Client published to the IOT core:</p>
<p>Right click and open <a href="https://view.highspot.com/viewer/6035695e34d6be36d2220cda">See the IOT device message published</a></p>
<pre class="codehilite"><code>type **disconnect** and press enter to Disconnect from the IOT core connection

type exit and press enter to exit out of the MQTT shell
</code></pre>

<p><strong>Publishing from IOT core to the MQTT Client:</strong></p>
<p>Open the mqtt shell by typing the following command :</p>
<pre class="codehilite"><code>mqtt shell
</code></pre>

<p>Connect to IOT core using the following command :</p>
<pre class="codehilite"><code>con -i mydevice

subscribe to the topic monthly_average_temperature by executing the following command :

sub -q 1 -t cloud/monthly_average_temperature -s -oc
</code></pre>

<p>From the IOT Core console, publish to the topic cloud/monthly_average_temperature </p>
<p>You should see the message "Hello from the IOT console" on the mqtt client within your Cloud9 environment</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p><a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
